<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>YELLOW Simulator</title>

    <link rel="icon" href="img/favicon.ico" type="image/x-icon">
    <link href="css/bootstrap.css" rel="stylesheet" type="text/css">
    <link href="css/bootstrap-grid.css" rel="stylesheet" type="text/css">
    <link href="css/bootstrap-reboot.css" rel="stylesheet" type="text/css">
    <link href="css/tempus.css" rel="stylesheet" type="text/css">
    <link href="css/fa470/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href="css/panels.css" rel="stylesheet" type="text/css">

    <style>
        #reqsBody > tr,
        #reqsBody > tr > td {
            height: 36px;
            padding-top: 0;
            padding-bottom: 0;
        }
    </style>

</head>
<body>
<br>
<div class="container">
    <div class="panel panel-warning">
        <div class="panel-heading text-center">
            <h1>YELLOW Simulator</h1>
        </div>
        <div class="panel-body" style="padding-bottom: 10px; padding-top: 10px" id="body">

            <div class="row justify-content-between">
                <div class="col-auto" id="subIdCol">
                    <table class="table table-striped">
                        <thead class="thead-dark">
                        <tr>
                            <td>Id</td>
                            <td>Response</td>
                            <td>Edit</td>
                            <td>Remove</td>
                        </tr>
                        </thead>
                        <tbody id="subIdReqsBody">
                        </tbody>
                    </table>
                </div>
                <div class="col" hidden>
                    <table class="table table-striped">
                        <thead class="thead-dark">
                        <tr>
                            <td>united</td>
                            <td>Response</td>
                            <td>Edit</td>
                            <td>Remove</td>
                        </tr>
                        </thead>
                        <tbody id="unitedReqsBody">
                        </tbody>
                    </table>
                </div>

                <div class="col-auto" id="unitedCol" style="display: none">
                    <table class="table table-striped">
                        <thead class="thead-dark">
                        <tr>
                            <td>par1</td>
                            <td>par2</td>
                            <td>par3a</td>
                            <td>par3b</td>
                            <td>par4a</td>
                            <td>par4b</td>
                            <td>Response</td>
                            <td>Edit</td>
                            <td>Remove</td>
                        </tr>
                        </thead>
                        <tbody id="unitedNewReqsBody">
                        </tbody>
                    </table>
                </div>
                <div class="col-auto">
                    <div class="btn btn-outline-dark" onclick="switchTables()">Switch</div>
                </div>

            </div>

            <div class="row">
                <div class="col-4" id="subIdPan">
                    <div class="row">
                        <div class="col-7">
                            <div class="form-group">
                                <input class="form-control" type="text" value="" minlength="1" id="subReqId"
                                       placeholder="Id"/>
                            </div>
                        </div>
                        <div class="col-5">
                            <div class="btn-group" role="group">
                                <button class="btn btn-outline-info" type="button" id="subSubmit" hidden
                                        onclick="sendXml(subId, true)"
                                        title="Add with validation">Validate
                                </button>
                                <button class="btn btn-outline-warning" type="button" id="subSwv"
                                        onclick="sendXml(subId, false)"
                                        title="Add without validation">!Validate
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col" hidden>
                    <div class="row">
                        <div class="col-7">
                            <div class="form-group">
                                <input class="form-control" type="text" value="" minlength="1" id="unitedReqId"
                                       placeholder="united"/>
                            </div>
                        </div>
                        <div class="col-5">
                            <div class="btn-group" role="group">
                                <button class="btn btn-outline-info" type="button" id="unitedSubmit" hidden
                                        onclick="sendXml(united, true)"
                                        title="Add with validation">Validate
                                </button>
                                <button class="btn btn-outline-warning" type="button" id="ibzSwv"
                                        onclick="sendXml(united, false)"
                                        title="Add without validation">!Validate
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-4" id="unitedPan" style="display: none">
                    <div class="row">
                        <div class="col-auto">
                            <div class="form-group">
                                <div style="display: flex">
                                    <input class="form-control" type="text" value="" minlength="1" id="par1FC"
                                           placeholder="par1" style="margin-right: 10px; margin-bottom: 5px"/>
                                    <input class="form-control" type="text" value="" minlength="1" id="par2FC"
                                           placeholder="par2" style="margin-right: 10px; margin-bottom: 5px"/>
                                    <input class="form-control" type="text" value="" minlength="1" id="par3aFC"
                                           placeholder="vpsz A" style="margin-right: 10px; margin-bottom: 5px"/>
                                </div>
                                <div style="display: flex">
                                    <input class="form-control" type="text" value="" minlength="1" id="par3bFC"
                                           placeholder="vpsz B" style="margin-right: 10px; margin-bottom: 5px"/>
                                    <input class="form-control" type="text" value="" minlength="1" id="par4aFC"
                                           placeholder="fsz A" style="margin-right: 10px; margin-bottom: 5px"/>
                                    <input class="form-control" type="text" value="" minlength="1" id="par4bFC"
                                           placeholder="par4b" style="margin-right: 10px; margin-bottom: 5px"/>
                                </div>
                            </div>
                        </div>
                        <div class="col-5" style="margin-bottom: 15px">
                            <div class="btn-group" role="group">
                                <button class="btn btn-outline-info" type="button" id="unitedPanSubmit" hidden
                                        onclick="sendXml(united, true)"
                                        title="Add with validation">Validate
                                </button>
                                <button class="btn btn-outline-warning" type="button" id="unitedPanSwv"
                                        onclick="sendXml(united, false)"
                                        title="Add without validation">!Validate
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-12">
                        <textarea class="form-control" minlength="1" id="xml" placeholder="xml response"
                                  style="font-size: 14px; height: 200px"></textarea>
                </div>
            </div>


        </div>
        <div class="panel-footer">
            <div class="row justify-content-end">
                <div class="col-auto">
                    <span>*developed by Stanislav.Tretyakov@t-systems.com</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!--All this is for date and time picking only-->
<script type="text/javascript" src="js/jQuery341.js"></script>
<script type="text/javascript" src="js/bootstrap.bundle.js"></script>
<script type="text/javascript" src="js/moment.js"></script>
<script type="text/javascript" src="js/tempus.js"></script>

<script>
    const subId = 'SUB_ID';
    const united = 'united';
    let restController;
    document.addEventListener('DOMContentLoaded', function () {
        defineRest();
        let url = new URL(restController + '/getReqs');
        fetch(url).then(function (response) {
            return response.status === 200 ? response.json() : [[response.message][response.message]]
        }).then(resp => {
            drawTheRow(document.getElementById("subIdReqsBody"), resp[0], subId);
            drawTheunitedRow(document.getElementById("unitedNewReqsBody"), resp[1], united);
        });
    });

    const switchTables = function () {
        let subCol = document.getElementById("subIdCol");
        let unitedCol = document.getElementById("unitedCol");
        let subPan = document.getElementById("subIdPan");
        let unitedPan = document.getElementById("unitedPan");
        if (subCol.style.display !== "none") {
            subCol.style.display = "none";
            subPan.style.display = "none";
            document.getElementById("subReqId").removeAttribute("readonly");
            unitedCol.style.display = "inline";
            unitedPan.style.display = "inline";
        } else {
            subCol.style.display = "inline";
            subPan.style.display = "inline";
            setunitedReadonly(false);
            unitedCol.style.display = "none";
            unitedPan.style.display = "none";
        }
        document.getElementById("xml").value = "";
        document.getElementById("xml").removeAttribute("readonly");
    };

    const drawTheunitedRow = function (table, array, type) {
        for (let el in array) {
            let arr = array[el].toString().split("=");
            table.innerHTML = table.innerHTML + "<tr compositeid='" + array[el] + "'>" +
                "<td style='padding-top: 6px'>" + arr[1].substring(0, arr[1].indexOf("&")) + "</td>" +
                "<td style='padding-top: 6px'>" + arr[2].substring(0, arr[2].indexOf("&")) + "</td>" +
                "<td style='padding-top: 6px'>" + arr[3].substring(0, arr[3].indexOf("&")) + "</td>" +
                "<td style='padding-top: 6px'>" + arr[4].substring(0, arr[4].indexOf("&")) + "</td>" +
                "<td style='padding-top: 6px'>" + arr[5].substring(0, arr[5].indexOf("&")) + "</td>" +
                "<td style='padding-top: 6px'>" + arr[6] + "</td>" +
                "<td>" + getShowButton(array[el], type) +
                "</td><td>" + getUpdateButton(array[el], type) + "</td><td>" +
                getDeleteButton(array[el], type) + "</td></tr>";
        }
    };

    const drawTheRow = function (table, array, type) {
        for (let el in array) {
            table.innerHTML = table.innerHTML + "<tr compositeid='" + array[el] + "'><td style='padding-top: 6px'>"
                + array[el] + "</td><td>" + getShowButton(array[el], type)
                + "</td><td>" + getUpdateButton(array[el], type) + "</td><td>"
                + getDeleteButton(array[el], type) + "</td></tr>";
        }
    };

    const defineRest = function () {
        let loc = window.location.href;
        let endLine = loc.indexOf("?") === -1 ? loc.length : loc.indexOf("?");
        restController = loc.substring(0, endLine - 4) + "irpm";
    };

    function getDeleteButton(el, type) {
        return '<button class="btn btn-outline-danger" style="padding-top: 0px; padding-bottom: 2px; margin-top: 3px"' +
            ' type="button" onclick="deleteResp(\'' + el + '\',\'' + type + '\')">Remove</button>'
    }

    function deleteResp(el, type) {
        let url = new URL(restController + '/remove');
        url.search = new URLSearchParams({id: el, type: type});
        let requestFailed = false;
        fetch(url, {
            method: 'DELETE'
        }).then(function (response) {
            if (response.status === 200)
                return response.text();
            else {
                requestFailed = true;
                return response.message
            }
        }).then(resp => {
            if (requestFailed) alert(resp);
            else {
                let table = document.getElementById(type === subId ? "subIdReqsBody" : "unitedNewReqsBody");
                for (let i = 0; i < table.children.length; i++) {
                    if (table.children[i].getAttribute("compositeid") === resp) {
                        table.removeChild(table.children[i]);
                        break;
                    }
                }
            }
        });
    }

    function getShowButton(el, type) {
        return '<button class="btn btn-outline-info" style="padding-top: 0; padding-bottom: 2px; margin-top: 3px"' +
            ' type="button" onclick="showResp(\'' + el + '\',\'' + type + '\')">Show</button>'
    }

    function showResp(el, type) {
        let url = new URL(restController + '/getResp');
        url.search = new URLSearchParams({id: el, type: type});
        fetch(url).then(function (response) {
            return response.status === 200 ? response.text() : response.message
        }).then(resp => {
            if (type === subId) {
                let id = "subReqId";
                document.getElementById(id).value = el;
                document.getElementById(id).setAttribute("readonly", "true");
            } else {
                parseunitedId(el);
                setunitedReadonly(true);
            }
            document.getElementById("xml").style.height = "800px";
            document.getElementById("xml").setAttribute("readonly", "true");
            document.getElementById("xml").value = resp;
        });
    }

    function getUpdateButton(el, type) {
        return '<button class="btn btn-outline-warning" style="padding-top: 0; padding-bottom: 2px; margin-top: 3px"' +
            ' type="button" onclick="updateResp(\'' + el + '\',\'' + type + '\')">Update</button>'
    }

    function setunitedReadonly(bool) {
        if (bool) {
            document.getElementById("par1FC").setAttribute("readonly", "true");
            document.getElementById("par2FC").setAttribute("readonly", "true");
            document.getElementById("par3aFC").setAttribute("readonly", "true");
            document.getElementById("par3bFC").setAttribute("readonly", "true");
            document.getElementById("par4aFC").setAttribute("readonly", "true");
            document.getElementById("par4bFC").setAttribute("readonly", "true");
        } else {
            document.getElementById("par1FC").removeAttribute("readonly");
            document.getElementById("par2FC").removeAttribute("readonly");
            document.getElementById("par3aFC").removeAttribute("readonly");
            document.getElementById("par3bFC").removeAttribute("readonly");
            document.getElementById("par4aFC").removeAttribute("readonly");
            document.getElementById("par4bFC").removeAttribute("readonly");
        }
    }

    function parseunitedId(largeId) {
        let id = largeId.toString().split("=");
        document.getElementById("par1FC").value = id[1].substring(0, id[1].indexOf("&"));
        document.getElementById("par2FC").value = id[2].substring(0, id[2].indexOf("&"));
        document.getElementById("par3aFC").value = id[3].substring(0, id[3].indexOf("&"));
        document.getElementById("par3bFC").value = id[4].substring(0, id[4].indexOf("&"));
        document.getElementById("par4aFC").value = id[5].substring(0, id[5].indexOf("&"));
        document.getElementById("par4bFC").value = id[6];
    }

    function updateResp(el, type) {
        let url = new URL(restController + '/getResp');
        url.search = new URLSearchParams({id: el, type: type});
        let failedRequest = false;
        fetch(url).then(function (response) {
            if (response.status === 200)
                return response.text();
            else {
                failedRequest = true;
                return response.message;
            }
        }).then(resp => {
            if (failedRequest) alert(resp);
            else {
                if (type === subId) {
                    let id = "subReqId";
                    document.getElementById(id).value = el;
                    document.getElementById("xml").value = resp;
                    document.getElementById(id).removeAttribute("readonly");
                    document.getElementById("xml").removeAttribute("readonly");
                } else {
                    parseunitedId(el);
                    setunitedReadonly(false);

                    document.getElementById("xml").value = resp;
                    document.getElementById("xml").removeAttribute("readonly");
                }
            }
        });

    }

    function validateCompositeId() {
        let par1FC = document.getElementById("par1FC").value;
        let par2FC = document.getElementById("par2FC").value;
        let par3aFC = document.getElementById("par3aFC").value;
        let par3bFC = document.getElementById("par3bFC").value;
        let par4aFC = document.getElementById("par4aFC").value;
        let par4bFC = document.getElementById("par4bFC").value;
        let validatingArray = [par1FC, par2FC, par3aFC, par3bFC, par4aFC, par4bFC];
        for (let i = 0; i < validatingArray.length; i++) {
            if (validatingArray[i].toString().trim() === "") return "";
        }
        return `par1=${par1FC}&par2=${par2FC}&par3a=${par3aFC}&par3b=${par3bFC}&par4a=${par4aFC}&par4b=${par4bFC}`;
    }

    function sendXml(type, validate) {
        let id = type === subId ? document.getElementById("subReqId").value : validateCompositeId();
        let xml = document.getElementById("xml").value || "BLANK_@_XML_#_RESPONSE";
        if (id.toString().trim() !== "") {
            let failedRequest = false;
            let url = new URL(restController + '/addResp');
            url.search = new URLSearchParams({validate: validate, type: type});
            fetch(url, {
                method: 'POST',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    req: id,
                    xml: xml
                })
            }).then(function (response) {
                if (response.status !== 200)
                    failedRequest = true;
                return response.text();
            }).then(function (resp) {
                if (failedRequest) {
                    console.log(resp);
                    alert(resp);
                } else {
                    let exists = false;
                    let table = document.getElementById(type === subId ? "subIdReqsBody" : "unitedNewReqsBody");
                    for (let i = 0; i < table.children.length; i++) {
                        if (table.children[i].getAttribute("compositeid") === resp) {
                            exists = true;
                            break;
                        }
                    }
                    if (!exists) {
                        if (type === subId) {
                            drawTheRow(table, [resp], type);
                        } else {
                            drawTheunitedRow(table, [resp], type);
                        }
                    }
                    document.getElementById("subReqId").value = "";
                    document.getElementById("xml").value = "";
                    document.getElementById("xml").removeAttribute("readonly");
                }
            });
        } else {
            console.log("Fill the fields!");
            alert("Fill the fields!");
        }
    }

</script>

</body>
</html>